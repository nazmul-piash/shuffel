<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Multiplayer Token Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for general text, Caveat for handwriting -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Caveat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer shadow */
            padding: 2.5rem; /* More padding */
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem; /* Rounded corners for buttons */
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); /* Button shadow */
        }
        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo on hover */
            transform: translateY(-2px); /* Slight lift effect */
            box-shadow: 0 6px 15px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
            padding: 0.8rem 1.8rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(107, 114, 128, 0.3);
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.4);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }
        .input-field {
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            color: #374151; /* Dark gray text */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1; /* Focus color */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Focus ring */
        }
        .handwriting-font {
            font-family: 'Caveat', cursive;
            font-size: 1.5rem; /* Larger for readability */
        }
        .message-box {
            background-color: #d1fae5; /* Light green for success */
            border: 1px solid #34d399; /* Green border */
            color: #065f46; /* Dark green text */
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 600;
            display: none; /* Hidden by default */
        }
        .message-box.error {
            background-color: #fee2e2; /* Light red for error */
            border-color: #ef4444; /* Red border */
            color: #991b1b; /* Dark red text */
        }
        /* Style for individual token input fields */
        .token-text-input {
            border: 1px solid #c7d2fe;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            width: 100%;
            box-sizing: border-box;
            resize: vertical; /* Allow vertical resizing */
            min-height: 50px; /* Minimum height for textarea */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .copy-button {
            background-color: #10b981; /* Emerald green */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            margin-left: 10px;
        }
        .copy-button:hover {
            background-color: #059669; /* Darker emerald */
        }
        .player-indicator {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 700;
            color: #4f46e5;
            background-color: #e0e7ff;
            border: 2px solid transparent;
            transition: all 0.3s ease-in-out;
        }
        .player-indicator.active {
            border-color: #4f46e5;
            background-color: #c7d2fe;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }
        .token-pile {
            background-color: #a5b4fc; /* Slightly darker indigo for folded state */
            color: #ffffff;
            font-size: 2.5rem; /* Larger font for count */
            font-weight: 700;
            width: 120px;
            height: 120px;
            border-radius: 1.5rem; /* More rounded */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto; /* Center the pile */
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease-in-out;
            cursor: pointer; /* Indicate it's clickable for Player 2 */
        }
        .token-pile:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(79, 70, 229, 0.4);
        }
        .token-pile.empty {
            background-color: #e2e8f0; /* Light gray when empty */
            color: #94a3b8;
            box-shadow: none;
            cursor: default;
        }
        .game-over-message {
            color: #ef4444; /* Red for game over */
            font-size: 1.8rem;
            font-weight: 700;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-5">
    <div class="container bg-white p-10 rounded-3xl shadow-xl flex flex-col items-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6">The Multiplayer Token Game</h1>
        <p id="userIdDisplay" class="text-sm text-gray-500 mb-4 break-all">Your User ID: <span id="currentUserId" class="font-mono">Loading...</span></p>

        <!-- Player Indicators -->
        <div class="flex justify-center gap-4 mb-6 w-full">
            <div id="player1Indicator" class="player-indicator">Player 1</div>
            <div id="player2Indicator" class="player-indicator">Player 2</div>
        </div>

        <!-- Initial Phase: Create or Join Game -->
        <div id="initial-phase" class="w-full">
            <p class="text-lg text-gray-600 mb-4">Welcome! What would you like to do?</p>
            <button id="createGameBtn" class="btn-primary w-full mb-4">Create New Game</button>
            <div class="flex items-center justify-center my-4">
                <span class="text-gray-500">OR</span>
            </div>
            <input type="text" id="gameIdInput" class="input-field mb-4" placeholder="Enter Game ID to Join">
            <button id="joinGameBtn" class="btn-secondary w-full">Join Game</button>
        </div>

        <!-- Waiting Phase (for Player 1 after creating game, or Player 2 after joining) -->
        <div id="waiting-phase" class="w-full hidden">
            <p class="text-lg text-gray-600 mb-4" id="waitingMessage">Waiting for other player...</p>
            <div id="inviteLinkContainer" class="mb-4 hidden">
                <p class="text-md text-gray-700 mb-2">Share this link with Player 2:</p>
                <div class="flex items-center justify-center">
                    <input type="text" id="inviteLink" class="input-field flex-grow mr-2" readonly>
                    <button id="copyLinkBtn" class="copy-button">Copy</button>
                </div>
            </div>
            <div class="loading-spinner"></div>
        </div>

        <!-- Phase 1: Specify Number of Tokens (Player 1 only) -->
        <div id="number-input-phase" class="w-full hidden">
            <p class="text-lg text-gray-600 mb-4">Player 1: How many tokens do you want?</p>
            <input type="number" id="numTokensInput" class="input-field mb-4" min="2" value="4" placeholder="Enter number of tokens (min 2)">
            <button id="generateTokenFieldsBtn" class="btn-primary w-full mb-6">Generate Token Fields</button>
        </div>

        <!-- Phase 2: Enter Token Content (Player 1 only) -->
        <div id="content-input-phase" class="w-full hidden">
            <p class="text-lg text-gray-600 mb-4">Player 1: Enter text for each token.</p>
            <div id="dynamicTokenInputs" class="flex flex-col gap-3 mb-6">
                <!-- Dynamic token input fields will be appended here -->
            </div>
            <button id="confirmTokensBtn" class="btn-primary w-full mb-6">Confirm Tokens & Shuffle</button>
        </div>

        <!-- Phase 3: Pick Token (Player 2 only) -->
        <div id="game-phase" class="w-full hidden">
            <p class="text-lg text-gray-600 mb-6" id="gamePhaseMessage">Player 2: Pick a token!</p>

            <!-- Visual Token Pile -->
            <div id="tokenPile" class="token-pile" title="Click to pick a token">
                <span id="tokenCount">0</span>
            </div>

            <button id="pickTokenBtn" class="btn-primary w-full mb-6">Pick a Token Randomly</button>

            <div id="revealedTokenContainer" class="message-box hidden">
                <p class="text-xl font-bold mb-2">You got:</p>
                <p id="revealedTokenContent" class="text-2xl text-indigo-700 font-extrabold break-words handwriting-font"></p>
            </div>

            <p id="gameOverMessage" class="game-over-message hidden">Game Over! All tokens picked.</p>

            <button id="resetGameBtn" class="btn-secondary w-full mt-8">Reset Game</button>
        </div>

        <!-- Message Box for Feedback -->
        <div id="messageBox" class="message-box w-full hidden"></div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase configuration from your Firebase project (provided by user)
        const firebaseConfig = {
            apiKey: "AIzaSyCz5NXK-P5FK-c8yh8oph2kgODB_cBoi1g",
            authDomain: "we-shuffle.firebaseapp.com",
            projectId: "we-shuffle",
            storageBucket: "we-shuffle.firebasestorage.app",
            messagingSenderId: "94132103590",
            appId: "1:94132103590:web:70f7ae80fe8c96dc664767",
            measurementId: "G-RGEF60JEKN"
        };

        // Derived from firebaseConfig
        const appId = firebaseConfig.appId;
        const initialAuthToken = null; // Not needed for anonymous sign-in in this context

        // Firebase App and Services
        let app, db, auth;
        let userId = null;
        let gameId = null;
        let unsubscribeFromGame = null; // To store the Firestore snapshot listener unsubscribe function

        // Game state variables
        let tokens = []; // Array to store the tokens
        let revealedToken = null;
        let numberOfTokensToGenerate = 0;
        let playerRole = null; // 'player1' or 'player2'
        let player1Id = null; // Store player1's actual ID
        let player2Id = null; // Store player2's actual ID

        // Get DOM elements
        const userIdDisplay = document.getElementById('currentUserId');
        const player1Indicator = document.getElementById('player1Indicator');
        const player2Indicator = document.getElementById('player2Indicator');
        const initialPhase = document.getElementById('initial-phase');
        const createGameBtn = document.getElementById('createGameBtn');
        const gameIdInput = document.getElementById('gameIdInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const waitingPhase = document.getElementById('waiting-phase');
        const waitingMessage = document.getElementById('waitingMessage');
        const inviteLinkContainer = document.getElementById('inviteLinkContainer');
        const inviteLink = document.getElementById('inviteLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const numberInputPhase = document.getElementById('number-input-phase');
        const numTokensInput = document.getElementById('numTokensInput');
        const generateTokenFieldsBtn = document.getElementById('generateTokenFieldsBtn');
        const contentInputPhase = document.getElementById('content-input-phase');
        const confirmTokensBtn = document.getElementById('confirmTokensBtn');
        const dynamicTokenInputs = document.getElementById('dynamicTokenInputs');
        const gamePhase = document.getElementById('game-phase');
        const gamePhaseMessage = document.getElementById('gamePhaseMessage');
        const tokenPile = document.getElementById('tokenPile'); // New element for token pile
        const tokenCountDisplay = document.getElementById('tokenCount'); // Span inside token pile
        const pickTokenBtn = document.getElementById('pickTokenBtn');
        const revealedTokenContainer = document.getElementById('revealedTokenContainer');
        const revealedTokenContent = document.getElementById('revealedTokenContent');
        const gameOverMessage = document.getElementById('gameOverMessage'); // New element for game over
        const resetGameBtn = document.getElementById('resetGameBtn');
        const messageBox = document.getElementById('messageBox');

        /**
         * Displays a message in the message box.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false otherwise.
         */
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'error');
            if (isError) {
                messageBox.classList.add('error');
            }
            messageBox.classList.remove('hidden');
            // Hide message after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Hides all game phases and shows only the specified one.
         * @param {HTMLElement} phaseToShow - The phase element to display.
         */
        function showPhase(phaseToShow) {
            initialPhase.classList.add('hidden');
            waitingPhase.classList.add('hidden');
            numberInputPhase.classList.add('hidden');
            contentInputPhase.classList.add('hidden');
            gamePhase.classList.add('hidden');
            phaseToShow.classList.remove('hidden');
        }

        /**
         * Updates the player indicators to show whose turn/role it is.
         * @param {string} activePlayerRole - 'player1', 'player2', or null/undefined for no active player.
         */
        function updatePlayerIndicators(activePlayerRole) {
            player1Indicator.classList.remove('active');
            player2Indicator.classList.remove('active');

            // Update display to show full User ID
            player1Indicator.textContent = player1Id ? `Player 1 (${player1Id.substring(0, 4)}...)` : 'Player 1';
            player2Indicator.textContent = player2Id ? `Player 2 (${player2Id.substring(0, 4)}...)` : 'Player 2';


            if (activePlayerRole === 'player1') {
                player1Indicator.classList.add('active');
            } else if (activePlayerRole === 'player2') {
                player2Indicator.classList.add('active');
            }
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // IMPORTANT: If you are seeing "auth/configuration-not-found" error,
                // it means Firebase Authentication is not enabled in your project.
                // Go to Firebase Console -> Authentication -> Get started, and enable
                // the "Anonymous" provider for this game to work.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("Authenticated with user ID:", userId);
                        // Check URL for gameId to auto-join
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlGameId = urlParams.get('gameId');
                        if (urlGameId) {
                            gameIdInput.value = urlGameId;
                            joinGame(); // Attempt to auto-join
                        } else {
                            showPhase(initialPhase); // Show initial options if no gameId in URL
                            updatePlayerIndicators(null); // No active player yet
                        }
                    } else {
                        userIdDisplay.textContent = 'Not Authenticated';
                        console.log("No user is signed in.");
                        showPhase(initialPhase); // Show initial options if no user
                        updatePlayerIndicators(null); // No active player yet
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessage("Failed to initialize game. Please try again later.", true);
            }
        }

        /**
         * Creates a new game session in Firestore.
         */
        async function createGame() {
            if (!userId) {
                showMessage("User not authenticated. Please wait.", true);
                return;
            }

            try {
                showPhase(waitingPhase);
                waitingMessage.textContent = "Creating game...";
                inviteLinkContainer.classList.add('hidden'); // Hide link until created

                const gamesCollectionRef = collection(db, `artifacts/${appId}/public/data/games`);
                const newGameRef = doc(gamesCollectionRef); // Firestore generates unique ID
                gameId = newGameRef.id;

                await setDoc(newGameRef, {
                    player1Id: userId,
                    player2Id: null,
                    status: 'waiting_for_player2',
                    tokens: [],
                    revealedToken: null,
                    createdAt: serverTimestamp(),
                    lastUpdated: serverTimestamp()
                });

                playerRole = 'player1';
                player1Id = userId; // Set player1Id locally
                const currentUrl = window.location.origin + window.location.pathname;
                inviteLink.value = `${currentUrl}?gameId=${gameId}`;
                inviteLinkContainer.classList.remove('hidden');
                waitingMessage.textContent = `Game created! Share this link with Player 2. Your Game ID: ${gameId}`;
                showMessage("Game created successfully!");

                // Start listening for game state changes
                listenToGameChanges();

            } catch (error) {
                console.error("Error creating game:", error);
                showMessage("Failed to create game. Please try again.", true);
                showPhase(initialPhase); // Go back to initial phase on error
            }
        }

        /**
         * Joins an existing game session.
         */
        async function joinGame() {
            if (!userId) {
                showMessage("User not authenticated. Please wait.", true);
                return;
            }

            const inputGameId = gameIdInput.value.trim();
            if (!inputGameId) {
                showMessage("Please enter a Game ID to join.", true);
                return;
            }

            try {
                showPhase(waitingPhase);
                waitingMessage.textContent = "Joining game...";
                inviteLinkContainer.classList.add('hidden'); // Hide link

                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, inputGameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showMessage("Game not found. Please check the Game ID.", true);
                    showPhase(initialPhase);
                    return;
                }

                const gameData = gameSnap.data();

                if (gameData.player1Id === userId || gameData.player2Id === userId) {
                    // Already part of this game
                    gameId = inputGameId;
                    playerRole = (gameData.player1Id === userId) ? 'player1' : 'player2';
                    player1Id = gameData.player1Id;
                    player2Id = gameData.player2Id; // Will be null if not yet joined
                    showMessage(`Rejoined game ${gameId} as ${playerRole}.`);
                    listenToGameChanges();
                    return;
                }

                if (gameData.player2Id && gameData.player2Id !== userId) {
                    showMessage("This game is already full.", true);
                    showPhase(initialPhase);
                    return;
                }

                // If player2Id is null, this user can join as player2
                await updateDoc(gameRef, {
                    player2Id: userId,
                    status: 'ready_to_create_tokens',
                    lastUpdated: serverTimestamp()
                });

                gameId = inputGameId;
                playerRole = 'player2';
                player1Id = gameData.player1Id; // Get player1Id from existing game data
                player2Id = userId; // Set player2Id locally
                waitingMessage.textContent = `Joined game ${gameId}! Waiting for Player 1 to create tokens...`;
                showMessage("Successfully joined game!");

                // Start listening for game state changes
                listenToGameChanges();

            } catch (error) {
                console.error("Error joining game:", error);
                showMessage("Failed to join game. Please try again.", true);
                showPhase(initialPhase); // Go back to initial phase on error
            }
        }

        /**
         * Sets up a real-time listener for the current game document.
         */
        function listenToGameChanges() {
            if (unsubscribeFromGame) {
                unsubscribeFromGame(); // Unsubscribe from previous listener if any
            }

            if (!gameId) {
                console.error("Cannot listen to game changes: gameId is null.");
                return;
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            unsubscribeFromGame = onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    // Update local player IDs from game data
                    player1Id = gameData.player1Id;
                    player2Id = gameData.player2Id;
                    console.log("Game state updated:", gameData);
                    updateUIBasedOnGameState(gameData);
                } else {
                    showMessage("Game ended or deleted. Resetting...", true);
                    resetGame(); // Game might have been deleted by other player
                }
            }, (error) => {
                console.error("Error listening to game changes:", error);
                showMessage("Lost connection to game. Please reset.", true);
            });
        }

        /**
         * Updates the UI based on the current game state from Firestore.
         * @param {object} gameData - The current game data from Firestore.
         */
        function updateUIBasedOnGameState(gameData) {
            tokens = gameData.tokens || [];
            revealedToken = gameData.revealedToken;

            // Update token pile display
            tokenCountDisplay.textContent = tokens.length;
            if (tokens.length === 0) {
                tokenPile.classList.add('empty');
                tokenPile.style.cursor = 'default';
            } else {
                tokenPile.classList.remove('empty');
                tokenPile.style.cursor = 'pointer';
            }

            // Hide game over message by default, show only when game ends
            gameOverMessage.classList.add('hidden');

            // Player 1's flow
            if (playerRole === 'player1') {
                updatePlayerIndicators('player1'); // Player 1 is active

                if (gameData.status === 'waiting_for_player2' && !gameData.player2Id) {
                    showPhase(waitingPhase);
                    waitingMessage.textContent = `Game created! Share this link with Player 2. Your Game ID: ${gameId}`;
                    inviteLinkContainer.classList.remove('hidden');
                } else if (gameData.status === 'ready_to_create_tokens' && gameData.player2Id) {
                    showPhase(numberInputPhase);
                    showMessage("Player 2 has joined! Please create your tokens.");
                } else if (gameData.status === 'tokens_created' || gameData.status === 'token_picked') {
                    // Player 1 sees the game is ready for picking by Player 2
                    showPhase(gamePhase);
                    gamePhaseMessage.textContent = "Player 2's Turn: Pick a token!";
                    pickTokenBtn.classList.add('hidden'); // Player 1 doesn't pick
                    revealedTokenContainer.classList.toggle('hidden', !revealedToken);
                    revealedTokenContent.textContent = revealedToken || '';

                    if (tokens.length === 0) {
                        gameOverMessage.classList.remove('hidden');
                        gamePhaseMessage.textContent = "Game Over!";
                    }
                }
            }
            // Player 2's flow
            else if (playerRole === 'player2') {
                updatePlayerIndicators('player2'); // Player 2 is active

                if (gameData.status === 'waiting_for_player2' || gameData.status === 'ready_to_create_tokens') {
                    showPhase(waitingPhase);
                    waitingMessage.textContent = `Joined game ${gameId}! Waiting for Player 1 to create tokens...`;
                    inviteLinkContainer.classList.add('hidden'); // Player 2 doesn't need invite link
                } else if (gameData.status === 'tokens_created' || gameData.status === 'token_picked') {
                    showPhase(gamePhase);
                    gamePhaseMessage.textContent = "Your Turn: Pick a token!";
                    pickTokenBtn.classList.remove('hidden'); // Player 2 can pick
                    revealedTokenContainer.classList.toggle('hidden', !revealedToken);
                    revealedTokenContent.textContent = revealedToken || '';

                    if (tokens.length === 0) {
                        pickTokenBtn.disabled = true;
                        gameOverMessage.classList.remove('hidden');
                        gamePhaseMessage.textContent = "Game Over!";
                        showMessage('All tokens picked! Reset to play again.', false);
                    } else {
                        pickTokenBtn.disabled = false; // Re-enable for next pick
                    }
                }
            }
        }

        /**
         * Generates the specified number of input fields for token content (Player 1).
         */
        function generateTokenInputFields() {
            const num = parseInt(numTokensInput.value, 10);

            if (isNaN(num) || num < 2) {
                showMessage('Please enter a number of tokens (minimum 2).', true);
                return;
            }

            numberOfTokensToGenerate = num;
            dynamicTokenInputs.innerHTML = ''; // Clear previous fields

            for (let i = 0; i < numberOfTokensToGenerate; i++) {
                const textarea = document.createElement('textarea');
                textarea.classList.add('input-field', 'token-text-input', 'handwriting-font');
                textarea.placeholder = `Enter text for Token ${i + 1}`;
                textarea.id = `tokenText_${i}`; // Unique ID for each textarea
                dynamicTokenInputs.appendChild(textarea);
            }

            showPhase(contentInputPhase);
            showMessage(`Generated ${numberOfTokensToGenerate} token input fields.`);
        }

        /**
         * Collects text from dynamic input fields and updates Firestore (Player 1).
         */
        async function confirmTokensAndStartGame() {
            if (!gameId || playerRole !== 'player1') {
                showMessage("You are not Player 1 or not in a game.", true);
                return;
            }

            const newTokens = [];
            let allFieldsFilled = true;

            for (let i = 0; i < numberOfTokensToGenerate; i++) {
                const textarea = document.getElementById(`tokenText_${i}`);
                if (textarea && textarea.value.trim() !== '') {
                    newTokens.push(textarea.value.trim());
                } else {
                    allFieldsFilled = false;
                    break; // Stop if any field is empty
                }
            }

            if (!allFieldsFilled) {
                showMessage('Please fill in text for all tokens before confirming.', true);
                return;
            }

            if (newTokens.length < 2) {
                showMessage('Something went wrong. Please ensure at least 2 tokens are entered.', true);
                return;
            }

            tokens = newTokens; // Update local tokens array

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
                await updateDoc(gameRef, {
                    tokens: tokens,
                    status: 'tokens_created',
                    revealedToken: null, // Reset revealed token for new game
                    lastUpdated: serverTimestamp()
                });
                showMessage('Tokens confirmed and saved! Player 2 can now pick.');
                // UI will be updated by the onSnapshot listener
            } catch (error) {
                console.error("Error confirming tokens:", error);
                showMessage("Failed to save tokens. Please try again.", true);
            }
        }

        /**
         * Randomly picks and reveals one token (Player 2).
         */
        async function pickToken() {
            if (!gameId || playerRole !== 'player2') {
                showMessage("You are not Player 2 or not in a game.", true);
                return;
            }

            if (tokens.length === 0) {
                showMessage('No tokens left to pick! Please reset the game.', true);
                return;
            }

            // Shuffle locally for randomness before picking
            const shuffledTokens = [...tokens]; // Create a copy to shuffle
            for (let i = shuffledTokens.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledTokens[i], shuffledTokens[j]] = [shuffledTokens[j], shuffledTokens[i]];
            }

            const randomIndex = Math.floor(Math.random() * shuffledTokens.length);
            const pickedTokenContent = shuffledTokens[randomIndex];

            // Remove the picked token from the local array
            const updatedTokens = tokens.filter(token => token !== pickedTokenContent);

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
                await updateDoc(gameRef, {
                    tokens: updatedTokens, // Update remaining tokens
                    revealedToken: pickedTokenContent,
                    status: 'token_picked', // Keep status as token_picked for continuous picking
                    lastUpdated: serverTimestamp()
                });
                showMessage('Token picked!');
                // UI will be updated by the onSnapshot listener
            } catch (error) {
                console.error("Error picking token:", error);
                showMessage("Failed to pick token. Please try again.", true);
            }
        }

        /**
         * Resets the game to its initial state and clears Firestore data.
         */
        async function resetGame() {
            if (unsubscribeFromGame) {
                unsubscribeFromGame(); // Stop listening to game changes
            }

            if (gameId && playerRole === 'player1') {
                try {
                    // Only Player 1 should delete the game document
                    await setDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), {}, { merge: false }); // Clear document
                    console.log("Game document cleared by Player 1.");
                } catch (error) {
                    console.error("Error clearing game document:", error);
                }
            }

            tokens = [];
            revealedToken = null;
            numberOfTokensToGenerate = 0;
            playerRole = null;
            player1Id = null;
            player2Id = null;
            gameId = null;
            numTokensInput.value = 4; // Reset to default value
            dynamicTokenInputs.innerHTML = ''; // Clear dynamic fields
            revealedTokenContainer.classList.add('hidden');
            pickTokenBtn.disabled = false;
            gameIdInput.value = ''; // Clear game ID input
            gameOverMessage.classList.add('hidden'); // Hide game over message

            // Clear URL parameters
            const url = new URL(window.location.href);
            url.searchParams.delete('gameId');
            window.history.replaceState({}, document.title, url.toString());

            showPhase(initialPhase);
            updatePlayerIndicators(null); // Reset indicators
            showMessage('Game reset. You can now create or join a new game!');
        }

        /**
         * Copies the invite link to the clipboard.
         */
        function copyInviteLink() {
            inviteLink.select();
            document.execCommand('copy'); // Fallback for navigator.clipboard.writeText() in iframes
            showMessage('Invite link copied to clipboard!');
        }

        // Event Listeners
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        generateTokenFieldsBtn.addEventListener('click', generateTokenInputFields);
        confirmTokensBtn.addEventListener('click', confirmTokensAndStartGame);
        pickTokenBtn.addEventListener('click', pickToken);
        tokenPile.addEventListener('click', () => { // Allow clicking the pile to pick
            if (playerRole === 'player2' && tokens.length > 0) {
                pickToken();
            } else if (playerRole === 'player2' && tokens.length === 0) {
                showMessage('No tokens left to pick! Reset the game to play again.', true);
            } else if (playerRole === 'player1') {
                showMessage('You are Player 1. Player 2 picks the tokens.', false);
            }
        });
        resetGameBtn.addEventListener('click', resetGame);
        copyLinkBtn.addEventListener('click', copyInviteLink);

        // Allow pressing Enter in the number input to generate fields
        numTokensInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                generateTokenFieldsBtn.click(); // Simulate button click
            }
        });

        // Allow pressing Enter in the game ID input to join
        gameIdInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                joinGameBtn.click(); // Simulate button click
            }
        });

        // Initialize Firebase on window load
        window.onload = initializeFirebase;

    </script>
</body>
</html>
